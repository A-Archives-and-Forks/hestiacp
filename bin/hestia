#!/bin/bash

HESTIA_BIN=$HESTIA/bin
[ "$HESTIA_DEBUG" ] && OSAL_DEBUG=1
source $HESTIA/func/osal.sh
source $HESTIA/func/main.sh
if [ -f $HESTIA/conf/hestia.conf ]; then
    source $HESTIA/conf/hestia.conf
fi

hestia() {
    if [[ -z $@ ]]; then
        echo "Hestia: command missing. Try 'hestia help' for more information."
        exit
    fi

    # Search for command file
    local cmd_name=''
    local cmd_file=''
    for arg in "$@"
    do
        # FIXME: secutirity (what is $arg is something like ../../../malicious_code)
        if [ -f "$HESTIA_BIN/$cmd_file/${arg}.inc" ]; then
            # Look for a hestia-cli include file (.inc)
            if [ $cmd_name ]; then
                cmd_name="${cmd_name}_${arg}"
                cmd_file=$HESTIA_BIN/$cmd_file/${arg}.inc
            else
                cmd_name=$arg
                cmd_file=$HESTIA_BIN/${arg}.inc
            fi
            cmd_type='include'
            shift
            break
        elif [ -d "$HESTIA_BIN/$cmd_file/${arg}" ]; then
            # Keep looking inside dirs
            if [ $cmd_name ]; then
                cmd_name="${cmd_name}_${arg}"
                cmd_file="${cmd_file}/${arg}"
            else
                cmd_name=$arg
                cmd_file=$arg
            fi
            cmd_type='dir'
            shift
        elif [ -x "$HESTIA_BIN/$cmd_file/${arg}" ]; then
            # Look for regular executable file
            if [ $cmd_name ]; then
                cmd_name="${cmd_name}_${arg}"
                cmd_file=$HESTIA_BIN/$cmd_file/${arg}
            else
                cmd_name=$arg
                cmd_file=$HESTIA_BIN/${arg}
            fi
            cmd_type='executable'
            shift
            break
        elif [ "$cmd_file" ]; then
            # We have a partial path, but component not found
            echo "Unrecognized command: $@ ('$arg' not found in $cmd_file)"
            return 1
            break
        fi
    done

    # Process the rest of the arguments as --arg or --arg value
    # https://brianchildress.co/named-parameters-in-bash/
    params=''
    for param in "$@"
    do
        if [[ $param == *"--"* ]]; then
            # It's a --parameter
            if [ "$param_name" ] && [ ! "${!param_name}" ]; then
                # Previous --arg is empty, so set it to true before continuing
                declare $param_name=1
            fi
            param_name=$(echo "param_${param:2}" | sed 's/-/_/')    # trim --, replace - with _
            # Add param_name to the list of used params (unless it's there already)
            [[ $params =~ (^|[[:space:]])$param_name($|[[:space:]]) ]] || params="$params $param_name"
            last_was='name'
        else
            # Not a --parameter, so it's a value
            if [ "$param_name" ]; then
                if [ "${!param_name}" ]; then
                    # Already has value... add to it
                    declare $param_name="${!param_name} $param"
                else
                    # Doesn't have value... initialize
                    declare $param_name="$param"
                fi
            fi
            last_was='value'
        fi
    done
    # Process trailing --boolean_param
    if [ "$last_was" == 'name' ]; then
        declare $param_name=1
    fi

    # Trim leading space
    [ "$params" ] && params="${params:1}"

    if [ $cmd_file ]; then
        if [ "$HESTIA_DEBUG" ]; then
            echo "Command file          : $cmd_file"
            echo "Command type          : $cmd_type"
            echo "Command function name : hestia_${cmd_name}()"
            echo "Remaining arguments   : $@"
            echo "Parameters used       : $params"
            echo "Parameter values      : "
            for param in $params; do
                echo "    --$param ${!param}"
            done
            echo ""
            echo "*** Now the command itself:"
            echo ""
        fi

        if [ "$cmd_type" = 'include' ]; then
            source $cmd_file
            hestia_$cmd_name $@
        elif [ "$cmd_type" = 'dir' ]; then
            # Found to dir level, but no file. Assume 'help' command
            source "$HESTIA_BIN/${cmd_file}/help.inc"
            cmd_name_help="${cmd_name}_help"
            hestia_$cmd_name_help
        else
            $cmd_file $@
        fi
    else
        echo "Unrecognized command: $@"
        return 1
    fi
}

# If this files is _not_ being sourced, act immediately
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    hestia $@
    hestia integrate pending
fi